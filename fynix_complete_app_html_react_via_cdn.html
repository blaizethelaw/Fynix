<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Fynix - Rise From Financial Ashes</title>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Keep p5 here, but BackgroundCanvas will also lazy-load it if unavailable to avoid ReferenceError -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --phoenix-orange: #f97316;
            --phoenix-red: #ea580c;
            --phoenix-yellow: #f59e0b;
            --phoenix-gold: #fbbf24;
            --phoenix-dark: #0a0e27;
            --glass-white: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #111827 100%);
            color: white; min-height: 100vh; overflow-x: hidden;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        #bgCanvas { position: fixed; top: 0; left: 0; z-index: 0; opacity: 0.3; pointer-events: none; }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        /* Animations */
        @keyframes phoenixRise { 0%,100%{ transform: translateY(0) scale(1);} 50%{ transform: translateY(-5px) scale(1.02);} }
        @keyframes glow { 0%,100%{ filter: brightness(1);} 50%{ filter: brightness(1.2);} }
        @keyframes slideIn { from{ opacity:0; transform: translateX(-20px);} to{ opacity:1; transform: translateX(0);} }
        @keyframes fadeIn { from{ opacity:0;} to{ opacity:1;} }
        @keyframes slideUp { from{ transform: translateY(20px); opacity:0;} to{ transform: translateY(0); opacity:1;} }
        .phoenix-glow{ animation: glow 3s ease-in-out infinite; }
        .phoenix-rise{ animation: phoenixRise 3s ease-in-out infinite; }
        .slide-in{ animation: slideIn 0.5s ease; }
        .fade-in{ animation: fadeIn 0.3s ease; }
        .glass{ background: var(--glass-white); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border); }
        .modal-overlay{ position: fixed; inset:0; background: rgba(0,0,0,0.95); display:flex; align-items:center; justify-content:center; z-index:9999; animation: fadeIn 0.3s ease; padding:1rem; }
        .modal-content{ background: linear-gradient(135deg, #1f2937, #111827); padding:1.5rem; border-radius:1rem; max-width:500px; width:100%; max-height:90vh; overflow-y:auto; border:1px solid var(--glass-border); animation: slideUp 0.3s ease; }
        .mobile-nav{ position:fixed; bottom:0; left:0; right:0; background:rgba(17,24,39,0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top:1px solid rgba(255,255,255,0.1); z-index:1000; padding:0.5rem; display:none; }
        @media (max-width: 768px){ .mobile-nav{ display:flex; justify-content:space-around; align-items:center; } .desktop-nav{ display:none !important; } .main-content{ padding-bottom: 70px !important; }}
        .tab-active{ background: linear-gradient(135deg, var(--phoenix-orange), var(--phoenix-red)); color:white; }
        .progress-bar{ background: rgba(255,255,255,0.1); border-radius:10px; overflow:hidden; height:8px; }
        .progress-fill{ background: linear-gradient(90deg, var(--phoenix-orange), var(--phoenix-yellow)); height:100%; transition: width 0.5s ease; position:relative; overflow:hidden; }
        .progress-fill::after{ content:''; position:absolute; inset:0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 2s infinite; }
        @keyframes shimmer { 0%{ transform: translateX(-100%);} 100%{ transform: translateX(100%);} }
        .tooltip{ position:relative; }
        .tooltip .tooltiptext{ visibility:hidden; background:rgba(0,0,0,0.9); color:white; text-align:center; border-radius:6px; padding:8px; position:absolute; z-index:100; bottom:125%; left:50%; margin-left:-75px; width:150px; opacity:0; transition:opacity 0.3s; font-size:0.75rem; }
        .tooltip:hover .tooltiptext{ visibility:visible; opacity:1; }
        .health-good{ background: linear-gradient(135deg, #10b981, #059669); }
        .health-warning{ background: linear-gradient(135deg, #f59e0b, #d97706); }
        .health-danger{ background: linear-gradient(135deg, #ef4444, #dc2626); }
        .responsive-grid{ display:grid; gap:1rem; }
        @media (min-width:640px){ .responsive-grid{ grid-template-columns: repeat(2, 1fr);} }
        @media (min-width:1024px){ .responsive-grid{ grid-template-columns: repeat(3, 1fr);} }
        button, .btn{ min-height:44px; min-width:44px; touch-action: manipulation; }
        input, select, textarea{ font-size:16px; }
        @media (hover:hover){ .hover-card:hover{ transform: translateY(-2px); box-shadow: 0 10px 20px rgba(249,115,22,0.1);} }
        .text-responsive{ font-size: clamp(0.875rem, 2vw, 1rem); }
        .heading-responsive{ font-size: clamp(1.5rem, 4vw, 2.5rem); }
        .safe-top{ padding-top: env(safe-area-inset-top); }
        .safe-bottom{ padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
// ==================== ICONS ====================
const Icons = {
  Phoenix: () => (
    <img
      src="https://i.imgur.com/VXfQFab.png"
      alt="Fynix Logo"
      className="w-10 h-10 md:w-12 md:h-12 phoenix-rise"
      onError={(e) => {
        e.target.onerror = null;
        e.target.style.display = 'none';
        e.target.parentElement.innerHTML = '<div class="w-10 h-10 md:w-12 md:h-12 bg-gradient-to-br from-orange-500 to-red-500 rounded-lg flex items-center justify-center font-bold text-lg">F</div>';
      }}
    />
  ),
  Dashboard: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
  ),
  Dollar: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 1v22M17 5a4 4 0 0 0-4-2H9a3 3 0 0 0 0 6h6a3 3 0 0 1 0 6H7"/></svg>
  ),
  Calculator: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="8" x2="8" y1="10" y2="14"/></svg>
  ),
  Book: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
  ),
  Chart: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 17l6-6 4 4 7-7"/></svg>
  ),
  Target: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
  ),
  Plus: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5v14M5 12h14"/></svg>
  ),
  Trash: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"/></svg>
  ),
  Check: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 6L9 17l-5-5"/></svg>
  ),
  Sparkles: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 2l2 4 4 2-4 2-2 4-2-4-4-2 4-2zM5 11l1 2 2 1-2 1-1 2-1-2-2-1 2-1z"/></svg>
  ),
  Download: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
  ),
  Upload: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
  ),
  Calendar: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M3 8h18M8 2v4M16 2v4"/></svg>
  ),
  Lightbulb: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6M10 22h4"/></svg>
  ),
  Brain: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0  0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0  0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>
  ),
  Flame: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>
  ),
  Wallet: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 1 0 4 0 2 2 0 1 0-4 0"/></svg>
  ),
  Menu: () => (
    <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
  ),
  Close: () => (
    <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
  ),
  Wifi: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></svg>
  ),
  Youtube: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0  0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
  ),
  ExternalLink: () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 3h6v6"/><path d="M10 14L21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>
  ),
};

// ==================== UTILITIES ====================
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2,
  }).format(amount || 0);
};
const uid = () => Math.random().toString(36).slice(2, 11);
const daysInMonth = (date = new Date()) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
const daysUntilDue = (dueDay, today = new Date()) => {
  const currentDay = today.getDate();
  const totalDays = daysInMonth(today);
  if (dueDay >= currentDay) return dueDay - currentDay; else return (totalDays - currentDay) + dueDay;
};
const saveState = (data) => localStorage.setItem('fynix_state_v1', JSON.stringify(data));
const loadState = () => {
  try { const s = localStorage.getItem('fynix_state_v1'); return s ? JSON.parse(s) : null; } catch { return null; }
};

// Helper to lazy-load a script exactly once
const ensureScript = (src, globalName) => new Promise((resolve, reject) => {
  if (window[globalName]) return resolve(window[globalName]);
  // If a matching script is already in the DOM, wait for it
  const existing = Array.from(document.scripts).find(s => s.src.includes(src));
  const tag = existing || Object.assign(document.createElement('script'), { src, async: true });
  const cleanup = () => { tag.onload = null; tag.onerror = null; };
  tag.onload = () => { cleanup(); resolve(window[globalName]); };
  tag.onerror = () => { cleanup(); reject(new Error(`Failed to load ${src}`)); };
  if (!existing) document.head.appendChild(tag);
});

// Guides data structure
const guidesData = [
  { id: 'part1', title: 'Part I: Financial Triage', sections: [
    { id: 'sec1-1', title: 'The Garnishment Gauntlet', takeaway: 'Reframe garnishment as a fixed expense, not a loss.', content: `Understanding wage garnishment is crucial for financial recovery. Federal law limits garnishment to 25% of disposable earnings for regular debts, but child support can take up to 60%. The key mindset shift: treat garnishment as your first "bill" and budget from what remains.

Your rights include:
- Notification before garnishment begins
- Right to challenge the order in court
- Ability to file for financial hardship exemption
- Option to negotiate alternative payment plans

Remember: This is temporary. Focus on what you can control.`, resources:[{type:'link', title:'FTC Guide to Wage Garnishment', url:'https://consumer.ftc.gov/articles/wage-garnishment'},{type:'youtube', title:'Understanding Your Rights', url:'https://www.youtube.com/watch?v=garnishment'}], actionable:{type:'add_saving', name:'Legal Fund', goal:500} },
    { id: 'sec1-2', title: 'Zero-Based Budgeting', takeaway: 'Every dollar gets a job before the month begins.', content: `Zero-Based Budgeting means Income - Expenses = $0 (on purpose!).

Steps:
1. Start with your post-tax, post-garnishment income
2. List and subtract the Four Walls (Food, Utilities, Shelter, Transport)
3. Subtract all other fixed bills and minimum debt payments
4. Allocate remaining to variable spending categories
5. Assign final dollars to your primary goal (emergency fund)

For irregular income: Use your LOWEST monthly income from the past 6 months as your baseline. Any extra is bonus for debt/savings.`, actionable:{ type:'add_saving', name:'Budget Buffer', goal:200 } },
    { id: 'sec1-3', title: 'Emergency Fund', takeaway: 'Build $1,000 before paying off any debt.', content: `Your starter emergency fund is your financial armor. Without it, every surprise expense becomes new debt.

Fast-track strategies:
- Sell everything you don't absolutely need
- Take on extra shifts or gig work
- Direct 100% of windfalls (tax refunds, bonuses) here
- Set up automatic $25/week transfers
- Cancel all non-essential subscriptions temporarily

Timeline:
- $25/week = 40 weeks to $1,000
- $50/week = 20 weeks to $1,000
- $100/week = 10 weeks to $1,000

This fund is for TRUE emergencies only: job loss, medical bills, car repairs that prevent you from working.`, actionable:{ type:'add_saving', name:'Emergency Fund', goal:1000 } },
  ]},
  { id: 'part2', title: 'Part II: Credit Comeback', sections: [
    { id: 'sec2-1', title: 'Credit Score Factors', takeaway: 'Payment history (35%) and utilization (30%) are 65% of your score.', content: `FICO Score Breakdown:
- Payment History (35%): NEVER miss a payment
- Credit Utilization (30%): Keep under 10% for best results
- Length of History (15%): Keep old accounts open
- Credit Mix (10%): Have both cards and loans
- New Credit (10%): Limit applications to 1-2 per year

Quick wins:
- Set up autopay for minimums on everything
- Pay down cards to 9% utilization
- Become authorized user on old, perfect account
- Dispute ALL errors on reports`, resources:[{type:'link', title:'Annual Credit Report', url:'https://www.annualcreditreport.com'}] },
    { id: 'sec2-2', title: '12-Month Credit Plan', takeaway: 'Systematic approach: Foundation â†’ Building â†’ Optimization', content: `Months 1-3: Foundation
- Pull all 3 credit reports
- Dispute every error
- Apply for credit-builder loan
- Send goodwill letters for late payments

Months 4-6: Building
- Get secured credit card ($200-500 deposit)
- Become authorized user on trusted account
- Set up autopay for everything
- Keep utilization under 10%

Months 7-12: Optimization
- Request credit limit increases (no hard pull)
- Pay down to 1% before statement closes
- NO new applications
- Monitor scores weekly

Expected results: 50-150 point increase in 12 months`, actionable:{ type:'add_saving', name:'Secured Card Deposit', goal:300 } },
  ]},
  { id: 'part3', title: 'Part III: Wealth Building', sections: [
    { id: 'sec3-1', title: 'Debt Strategies', takeaway: 'Snowball for motivation, Avalanche for math, Snow-Lanche for both.', content: `Debt Snowball (Psychological Win):
- List debts smallest to largest
- Pay minimums on all
- Attack smallest with everything extra
- Roll payment to next after payoff

Debt Avalanche (Mathematical Win):
- List debts by interest rate (highest first)
- Pay minimums on all
- Attack highest rate with everything extra
- Saves most money on interest

The Snow-Lanche Hybrid:
1. Pay off 1-2 smallest debts for quick wins
2. Switch to avalanche for remaining debts
3. Best of both worlds!`, resources:[{type:'youtube', title:'Debt Free in 18 Months', url:'https://www.youtube.com/watch?v=debt'}] },
    { id: 'sec3-2', title: 'Investment Priorities', takeaway: '401k match â†’ Roth IRA â†’ Max 401k â†’ Taxable', content: `Investment Order of Operations:

1. 401(k) to employer match (100% instant return!)
2. Roth IRA to max ($6,500/year)
   - Secret: Withdraw contributions anytime tax-free
   - Functions as backup emergency fund
3. Max out 401(k) ($23,000/year)
4. HSA if available ($3,850 single/$7,750 family)
5. Taxable brokerage account

Simple portfolio:
- Age 20-40: 100% stocks (VTI or VT)
- Age 40-60: Add 20-30% bonds (BND)
- Age 60+: 40-50% bonds

Compound interest example:
$200/month for 30 years at 8% = $293,509
Start NOW, time is your superpower!`, actionable:{ type:'add_saving', name:'Roth IRA Fund', goal:500 } },
  ]},
];

// ==================== BACKGROUND ANIMATION ====================
const BackgroundCanvas = () => {
  React.useEffect(() => {
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

    let instance = null;
    const start = () => {
      if (!window.p5) { console.warn('p5 unavailable; background animation disabled.'); return; }
      const sketch = (p) => {
        let particles = []; let canvas;
        p.setup = () => {
          canvas = p.createCanvas(p.windowWidth, p.windowHeight);
          canvas.position(0,0); canvas.style('position','fixed'); canvas.style('z-index','0'); canvas.id('bgCanvas');
          const particleCount = p.windowWidth < 768 ? 15 : 25;
          for (let i=0;i<particleCount;i++){
            particles.push({ x:p.random(p.width), y:p.random(p.height), size:p.random(2,4), speedX:p.random(-0.3,0.3), speedY:p.random(-0.5,-1), opacity:p.random(30,100) });
          }
        };
        p.draw = () => {
          p.clear();
          particles.forEach((particle)=>{
            p.noStroke(); p.fill(249,115,22, particle.opacity); p.ellipse(particle.x, particle.y, particle.size);
            particle.x += particle.speedX; particle.y += particle.speedY; particle.opacity -= 0.3;
            if (particle.y < -10 || particle.opacity <= 0){ particle.x = p.random(p.width); particle.y = p.height + 10; particle.opacity = p.random(30,100);} 
            if (particle.x < 0) particle.x = p.width; if (particle.x > p.width) particle.x = 0;
          });
        };
        p.windowResized = () => p.resizeCanvas(p.windowWidth, p.windowHeight);
      };
      try { instance = new window.p5(sketch); } catch (e) { console.warn('p5 init failed:', e); }
    };

    if (window.p5) start();
    else {
      // Lazy-load p5 if the CDN was blocked or loaded after Babel executes
      ensureScript('https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js', 'p5')
        .then(start)
        .catch(() => console.warn('Could not load p5; continuing without background.'));
    }

    return () => { if (instance && instance.remove) { try { instance.remove(); } catch {} } };
  }, []);
  return null;
};

// ==================== SETUP WIZARD ====================
const SetupWizard = ({ onComplete }) => {
  const [step, setStep] = React.useState(1);
  const [data, setData] = React.useState({ name:'', income:'', incomeType:'salary', goal:'emergency' });
  const handleSubmit = (e) => {
    e.preventDefault();
    if (step < 3) setStep(step+1); else {
      onComplete({ ...data, income: parseFloat(data.income)||3000, expenses: [], savingsGoals: [], transactions: [], settings: { cycleMode:'actual', allocationMode:'even', roundTo:'cent' } });
    }
  };
  return (
    <div className="modal-overlay">
      <div className="modal-content">
        <div className="text-center mb-6">
          <div className="flex justify-center mb-4"><Icons.Phoenix/></div>
          <h2 className="text-2xl md:text-3xl font-bold bg-gradient-to-r from-orange-400 to-yellow-500 bg-clip-text text-transparent">Welcome to Fynix</h2>
          <p className="text-gray-400 mt-2 text-sm md:text-base">Rise from financial ashes to freedom</p>
        </div>
        <div className="flex justify-between mb-6">{[1,2,3].map(i=> (<div key={i} className={`flex-1 h-2 mx-1 rounded-full transition-all ${i<=step ? 'bg-orange-500' : 'bg-gray-700'}`}/>))}</div>
        <form onSubmit={handleSubmit}>
          {step===1 && (
            <div className="space-y-4 fade-in">
              <h3 className="text-xl font-semibold mb-4">Let's get to know you</h3>
              <div>
                <label className="block text-sm text-gray-400 mb-2">Your Name</label>
                <input type="text" value={data.name} onChange={(e)=>setData({...data, name:e.target.value})} className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:border-orange-500 focus:outline-none" placeholder="Enter your name" required />
              </div>
            </div>
          )}
          {step===2 && (
            <div className="space-y-4 fade-in">
              <h3 className="text-xl font-semibold mb-4">Your Income Details</h3>
              <div>
                <label className="block text-sm text-gray-400 mb-2">Monthly Income (After Tax)</label>
                <input type="number" value={data.income} onChange={(e)=>setData({...data, income:e.target.value})} className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:border-orange-500 focus:outline-none" placeholder="What hits your bank account" required />
              </div>
              <div>
                <label className="block text-sm text-gray-400 mb-2">Income Type</label>
                <select value={data.incomeType} onChange={(e)=>setData({...data, incomeType:e.target.value})} className="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:border-orange-500 focus:outline-none">
                  <option value="salary">Salaried (Fixed)</option>
                  <option value="hourly">Hourly (Variable)</option>
                  <option value="contract">Contract/Freelance</option>
                  <option value="multiple">Multiple Sources</option>
                </select>
              </div>
            </div>
          )}
          {step===3 && (
            <div className="space-y-4 fade-in">
              <h3 className="text-xl font-semibold mb-4">Your Primary Goal</h3>
              <div className="space-y-3">
                {[
                  { value: 'emergency', label: 'ðŸ›¡ï¸ Build Emergency Fund', desc: '$1,000 safety net' },
                  { value: 'debt', label: 'ðŸ’³ Eliminate Debt', desc: 'Become debt-free' },
                  { value: 'credit', label: 'ðŸ“ˆ Rebuild Credit', desc: 'Reach 700+ score' },
                  { value: 'save', label: 'ðŸ’° Save for Goal', desc: 'Specific purchase' },
                  { value: 'invest', label: 'ðŸš€ Start Investing', desc: 'Build wealth' },
                ].map(option => (
                  <label key={option.value} className="block">
                    <input type="radio" name="goal" value={option.value} checked={data.goal===option.value} onChange={(e)=>setData({...data, goal:e.target.value})} className="sr-only" />
                    <div className={`p-3 md:p-4 rounded-lg border-2 cursor-pointer transition-all ${data.goal===option.value? 'border-orange-500 bg-orange-500/10':'border-gray-700 hover:border-gray-600'}`}>
                      <div className="font-semibold text-sm md:text-base">{option.label}</div>
                      <div className="text-xs md:text-sm text-gray-400">{option.desc}</div>
                    </div>
                  </label>
                ))}
              </div>
            </div>
          )}
          <button type="submit" className="w-full mt-6 px-6 py-3 bg-gradient-to-r from-orange-500 to-red-500 rounded-lg font-semibold hover:from-orange-600 hover:to-red-600 transition-all text-sm md:text-base">{step<3? 'Continue':'Start My Fynix Journey ðŸ”¥'}</button>
        </form>
      </div>
    </div>
  );
};

// ==================== DASHBOARD COMPONENTS ====================
const MyCards = ({ balance }) => (
  <div className="glass p-4 md:p-6 rounded-xl shadow-lg hover-card">
    <h3 className="text-base md:text-lg font-semibold mb-3 md:mb-4">My Card</h3>
    <div className="p-4 md:p-5 rounded-lg text-white relative overflow-hidden h-40 md:h-48 flex flex-col justify-between bg-gradient-to-br from-gray-900 to-black">
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 opacity-10"><Icons.Phoenix/></div>
      <div className="relative z-10">
        <p className="text-xs md:text-sm opacity-80">Balance</p>
        <p className="text-xl md:text-2xl font-bold">{formatCurrency(balance)}</p>
      </div>
      <div className="flex justify-between items-center relative z-10">
        <p className="font-mono text-sm md:text-lg tracking-wider">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ 1234</p>
        <Icons.Wifi/>
      </div>
    </div>
  </div>
);

const BudgetHealth = ({ income, expenses, savings }) => {
  const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount||e.monthlyAmount||0), 0);
  const totalSavings = savings.reduce((sum, g) => sum + (g.saved || 0), 0);
  const available = income - totalExpenses;
  const ratio = income > 0 ? (totalExpenses / income) * 100 : 0;
  let status, statusClass, message;
  if (ratio > 100){ status='âš ï¸ Over Budget'; statusClass='health-danger'; message=`Spending ${formatCurrency(Math.abs(available))} more than income`; }
  else if (ratio > 90){ status='ðŸ˜° Tight'; statusClass='health-warning'; message='Consider reducing expenses'; }
  else { status='âœ… Healthy'; statusClass='health-good'; message=`${formatCurrency(available)} available`; }
  return (
    <div className="glass rounded-xl p-4 md:p-6 mb-4 md:mb-6">
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
        <h3 className="text-base md:text-lg font-semibold">Budget Health</h3>
        <div className={`px-3 py-1 rounded-full text-xs md:text-sm font-semibold ${statusClass} text-center`}>{status}</div>
      </div>
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
        <div className="text-center"><div className="text-lg md:text-2xl font-bold text-green-400">{formatCurrency(income)}</div><div className="text-xs text-gray-400">Income</div></div>
        <div className="text-center"><div className="text-lg md:text-2xl font-bold text-red-400">{formatCurrency(totalExpenses)}</div><div className="text-xs text-gray-400">Expenses</div></div>
        <div className="text-center"><div className="text-lg md:text-2xl font-bold text-blue-400">{formatCurrency(totalSavings)}</div><div className="text-xs text-gray-400">Saved</div></div>
        <div className="text-center"><div className="text-lg md:text-2xl font-bold text-yellow-400">{ratio.toFixed(0)}%</div><div className="text-xs text-gray-400">Ratio</div></div>
      </div>
      <div className="mt-4 p-3 bg-gray-800/50 rounded-lg"><p className="text-xs md:text-sm text-gray-300">{message}</p></div>
    </div>
  );
};

const DailyBreakdown = ({ expenses, income, settings }) => {
  const cycleDays = settings?.cycleMode === 'actual' ? daysInMonth() : 30;
  const dailyIncome = income / cycleDays;
  const dailyExpenses = expenses.map(exp => ({ ...exp, daily: (exp.amount||exp.monthlyAmount||0) / cycleDays, weekly: ((exp.amount||exp.monthlyAmount||0) / cycleDays) * 7, biweekly: ((exp.amount||exp.monthlyAmount||0) / cycleDays) * 14, }));
  const totalDaily = dailyExpenses.reduce((sum, e) => sum + e.daily, 0);
  const dailyBuffer = dailyIncome - totalDaily;
  return (
    <div className="glass rounded-xl p-4 md:p-6 hover-card">
      <h3 className="text-base md:text-lg font-semibold mb-4 flex items-center gap-2"><Icons.Sparkles/><span className="hidden sm:inline">Daily Chip-Away Plan</span><span className="sm:hidden">Daily Plan</span></h3>
      <div className="grid grid-cols-2 gap-3 mb-4">
        <div className="bg-gray-800/50 rounded-lg p-3"><div className="text-xs text-gray-400">Daily Income</div><div className="text-lg md:text-xl font-bold text-green-400">{formatCurrency(dailyIncome)}</div></div>
        <div className="bg-gray-800/50 rounded-lg p-3"><div className="text-xs text-gray-400">Daily Expenses</div><div className="text-lg md:text-xl font-bold text-red-400">{formatCurrency(totalDaily)}</div></div>
      </div>
      <div className={`p-3 rounded-lg mb-4 ${dailyBuffer >= 0 ? 'bg-green-500/10 border border-green-500/30' : 'bg-red-500/10 border border-red-500/30'}`}>
        <div className="text-xs text-gray-400">Daily Buffer</div>
        <div className={`text-lg md:text-xl font-bold ${dailyBuffer >= 0 ? 'text-green-400' : 'text-red-400'}`}>{formatCurrency(dailyBuffer)}</div>
      </div>
      {dailyExpenses.length>0 && (
        <div className="space-y-2">
          <h4 className="font-semibold text-xs md:text-sm text-gray-400">Today's Transfers</h4>
          <div className="max-h-40 overflow-y-auto space-y-2">
            {dailyExpenses.slice(0,3).map(exp => (
              <div key={exp.id} className="bg-gray-800/50 rounded-lg p-2 flex justify-between items-center">
                <div className="text-xs md:text-sm truncate pr-2">{exp.name}</div>
                <div className="text-xs md:text-sm font-bold text-orange-400 whitespace-nowrap">{formatCurrency(exp.daily)}/day</div>
              </div>
            ))}
            {dailyExpenses.length>3 && <div className="text-xs text-gray-500 text-center">+{dailyExpenses.length-3} more</div>}
          </div>
        </div>
      )}
    </div>
  );
};

const ExpenseManager = ({ expenses, onAdd, onRemove }) => {
  const [showForm, setShowForm] = React.useState(false);
  const [newExpense, setNewExpense] = React.useState({ name:'', amount:'', category:'Other', dueDay:'1', priority:'medium' });
  const categories = ['Housing','Utilities','Transport','Food','Debt','Insurance','Subscriptions','Other'];
  const handleSubmit = (e) => {
    e.preventDefault();
    onAdd({ id: uid(), ...newExpense, amount: parseFloat(newExpense.amount), dueDay: parseInt(newExpense.dueDay), monthlyAmount: parseFloat(newExpense.amount) });
    setNewExpense({ name:'', amount:'', category:'Other', dueDay:'1', priority:'medium' });
    setShowForm(false);
  };
  return (
    <div className="glass rounded-xl p-4 md:p-6">
      <div className="flex justify-between items-center mb-4">
        <h3 className="text-base md:text-lg font-semibold flex items-center gap-2"><Icons.Dollar/>Expenses</h3>
        <button onClick={()=>setShowForm(!showForm)} className="px-3 py-1.5 bg-orange-500 hover:bg-orange-600 rounded-lg flex items-center gap-1 transition-colors text-sm"><Icons.Plus/><span className="hidden sm:inline">Add</span></button>
      </div>
      {showForm && (
        <form onSubmit={handleSubmit} className="mb-4 p-3 bg-gray-800/50 rounded-lg space-y-3 fade-in">
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <input type="text" placeholder="Expense name" value={newExpense.name} onChange={(e)=>setNewExpense({...newExpense, name:e.target.value})} className="px-3 py-2 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm" required />
            <input type="number" placeholder="Amount" value={newExpense.amount} onChange={(e)=>setNewExpense({...newExpense, amount:e.target.value})} className="px-3 py-2 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm" step="0.01" required />
            <select value={newExpense.category} onChange={(e)=>setNewExpense({...newExpense, category:e.target.value})} className="px-3 py-2 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm">{['Housing','Utilities','Transport','Food','Debt','Insurance','Subscriptions','Other'].map(cat=>(<option key={cat} value={cat}>{cat}</option>))}</select>
            <input type="number" placeholder="Due day (1-31)" value={newExpense.dueDay} onChange={(e)=>setNewExpense({...newExpense, dueDay:e.target.value})} className="px-3 py-2 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm" min="1" max="31" />
          </div>
          <button type="submit" className="w-full px-4 py-2 bg-green-500 hover:bg-green-600 rounded-lg transition-colors text-sm">Add Expense</button>
        </form>
      )}
      <div className="space-y-2 max-h-60 overflow-y-auto">
        {expenses.map(expense => (
          <div key={expense.id} className="bg-gray-800/50 rounded-lg p-3 flex justify-between items-center group hover:bg-gray-800/70 transition-colors">
            <div className="flex-1 min-w-0">
              <div className="font-semibold text-sm truncate">{expense.name}</div>
              <div className="text-xs text-gray-400">{expense.category} â€¢ Due: {expense.dueDay}</div>
            </div>
            <div className="flex items-center gap-2">
              <div className="text-right">
                <div className="font-bold text-base md:text-lg">{formatCurrency(expense.amount||expense.monthlyAmount)}</div>
                <div className="text-xs text-gray-400">{formatCurrency((expense.amount||expense.monthlyAmount)/30)}/day</div>
              </div>
              <button onClick={()=>onRemove(expense.id)} className="opacity-0 group-hover:opacity-100 p-1 text-red-400 hover:text-red-300 transition-all"><Icons.Trash/></button>
            </div>
          </div>
        ))}
      </div>
      {expenses.length===0 && (
        <div className="text-center py-8 text-gray-500"><Icons.Wallet/><p className="mt-2 text-sm">No expenses added yet</p></div>
      )}
    </div>
  );
};

const SavingsGoals = ({ goals, onAdd, onUpdate, onRemove }) => {
  const [showForm, setShowForm] = React.useState(false);
  const [newGoal, setNewGoal] = React.useState({ name:'', goal:'' });
  const [quickAmount, setQuickAmount] = React.useState(25);
  const handleSubmit = (e) => {
    e.preventDefault();
    onAdd({ id: uid(), name: newGoal.name, goal: parseFloat(newGoal.goal), saved: 0, createdAt: new Date().toISOString() });
    setNewGoal({ name:'', goal:'' }); setShowForm(false);
  };
  const percent = (g)=> Math.min(100, Math.round(((g.saved||0)/(g.goal||1))*100));
  return (
    <div className="glass rounded-xl p-4 md:p-6">
      <div className="flex justify-between items-center mb-4">
        <h3 className="text-base md:text-lg font-semibold flex items-center gap-2"><Icons.Target/>Savings</h3>
        <button onClick={()=>setShowForm(!showForm)} className="px-3 py-1.5 bg-green-500 hover:bg-green-600 rounded-lg flex items-center gap-1 transition-colors text-sm"><Icons.Plus/><span className="hidden sm:inline">Add</span></button>
      </div>
      {showForm && (
        <form onSubmit={handleSubmit} className="mb-4 p-3 bg-gray-800/50 rounded-lg space-y-3 fade-in">
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <input type="text" placeholder="Goal name (e.g., Emergency Fund)" value={newGoal.name} onChange={(e)=>setNewGoal({...newGoal, name:e.target.value})} className="px-3 py-2 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm" required />
            <input type="number" placeholder="Target amount" value={newGoal.goal} onChange={(e)=>setNewGoal({...newGoal, goal:e.target.value})} className="px-3 py-2 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm" step="0.01" required />
          </div>
          <button type="submit" className="w-full px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors text-sm">Create Goal</button>
        </form>
      )}

      <div className="space-y-3 max-h-72 overflow-y-auto">
        {goals.map(g => (
          <div key={g.id} className="bg-gray-800/50 rounded-lg p-3">
            <div className="flex items-start justify-between gap-3">
              <div className="min-w-0">
                <div className="font-semibold text-sm truncate">{g.name}</div>
                <div className="text-xs text-gray-400">{formatCurrency(g.saved||0)} / {formatCurrency(g.goal||0)}</div>
              </div>
              <div className="text-right">
                <div className="text-xs">{percent(g)}%</div>
              </div>
            </div>
            <div className="progress-bar mt-2">
              <div className="progress-fill" style={{ width: `${percent(g)}%` }}></div>
            </div>
            <div className="flex items-center gap-2 mt-3 flex-wrap">
              <div className="flex items-center gap-2">
                <button onClick={()=>onUpdate(g.id, (g.saved||0) + quickAmount)} className="px-3 py-1.5 bg-orange-500 hover:bg-orange-600 rounded-lg text-xs">+{formatCurrency(quickAmount)}</button>
                <button onClick={()=>onUpdate(g.id, Math.max(0, (g.saved||0) - quickAmount))} className="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded-lg text-xs">-{formatCurrency(quickAmount)}</button>
              </div>
              <input type="number" className="px-2 py-1 bg-gray-700 rounded-md text-xs w-24" value={quickAmount} onChange={(e)=>setQuickAmount(parseFloat(e.target.value)||0)} />
              <div className="ml-auto flex items-center gap-2">
                <button onClick={()=>onUpdate(g.id, g.goal)} className="px-3 py-1.5 bg-green-600 hover:bg-green-700 rounded-lg text-xs flex items-center gap-1"><Icons.Check/>Mark Done</button>
                <button onClick={()=>onRemove(g.id)} className="px-3 py-1.5 bg-red-600/80 hover:bg-red-600 rounded-lg text-xs flex items-center gap-1"><Icons.Trash/>Remove</button>
              </div>
            </div>
          </div>
        ))}
      </div>
      {goals.length===0 && (
        <div className="text-center py-8 text-gray-500"><Icons.Target/><p className="mt-2 text-sm">No goals yet â€” add your first!</p></div>
      )}
    </div>
  );
};

// ==================== CHARTS ====================
const ExpenseBreakdownChart = ({ expenses }) => {
  const canvasRef = React.useRef(null);
  const chartRef = React.useRef(null);
  React.useEffect(()=>{
    const byCat = expenses.reduce((acc, e)=>{ const amt = e.amount||e.monthlyAmount||0; acc[e.category] = (acc[e.category]||0)+amt; return acc; },{});
    const labels = Object.keys(byCat);
    const data = Object.values(byCat);
    if (chartRef.current){ chartRef.current.destroy(); }
    if (!canvasRef.current) return;
    chartRef.current = new Chart(canvasRef.current.getContext('2d'), {
      type:'doughnut',
      data:{ labels, datasets:[{ data, borderWidth:0 }] },
      options:{ plugins:{ legend:{ labels:{ color:'#e5e7eb' } } }, cutout:'60%', responsive:true, maintainAspectRatio:false }
    });
    return ()=>{ if (chartRef.current) chartRef.current.destroy(); };
  }, [expenses]);
  if (!expenses.length) return (
    <div className="glass rounded-xl p-4 md:p-6 h-64 flex flex-col items-center justify-center text-gray-500">
      <Icons.Chart/>
      <p className="text-sm mt-2">Add expenses to see breakdown</p>
    </div>
  );
  return (
    <div className="glass rounded-xl p-4 md:p-6 h-64">
      <div className="flex items-center justify-between mb-2">
        <h3 className="text-base md:text-lg font-semibold">Spending by Category</h3>
      </div>
      <div className="h-[200px]"><canvas ref={canvasRef}/></div>
    </div>
  );
};

// ==================== GUIDES VIEWER ====================
const Guides = ({ onActionable }) => {
  const [open, setOpen] = React.useState({});
  const toggle = (id)=> setOpen((s)=> ({...s, [id]: !s[id]}));
  return (
    <div className="space-y-4">
      {guidesData.map(part => (
        <div key={part.id} className="glass rounded-xl p-4 md:p-6">
          <div className="flex items-center justify-between">
            <h3 className="text-lg md:text-xl font-bold">{part.title}</h3>
          </div>
          <div className="mt-4 space-y-3">
            {part.sections.map(sec => (
              <div key={sec.id} className="bg-gray-800/40 rounded-lg">
                <button onClick={()=>toggle(sec.id)} className="w-full text-left p-3 md:p-4 flex items-center justify-between">
                  <div>
                    <div className="font-semibold text-sm md:text-base">{sec.title}</div>
                    <div className="text-xs text-gray-400">{sec.takeaway}</div>
                  </div>
                  <span className="text-xs text-gray-400">{open[sec.id]? 'Hide':'Read'}</span>
                </button>
                {open[sec.id] && (
                  <div className="px-3 md:px-4 pb-3 md:pb-4 space-y-3 fade-in">
                    <pre className="whitespace-pre-wrap text-sm text-gray-200 leading-relaxed">{sec.content}</pre>
                    {sec.resources?.length>0 && (
                      <div className="text-xs text-gray-300 space-y-1">
                        <div className="font-semibold text-gray-200">Resources</div>
                        {sec.resources.map((r,i)=> (
                          <a key={i} href={r.url} target="_blank" rel="noreferrer" className="flex items-center gap-2 text-orange-400 hover:text-orange-300">
                            {r.type==='youtube'? <Icons.Youtube/> : <Icons.ExternalLink/>}
                            <span>{r.title}</span>
                          </a>
                        ))}
                      </div>
                    )}
                    {sec.actionable?.type==='add_saving' && (
                      <button onClick={()=> onActionable(sec.actionable)} className="px-3 py-2 bg-gradient-to-r from-orange-500 to-red-500 rounded-md text-sm font-semibold">
                        Add "{sec.actionable.name}" Goal ({formatCurrency(sec.actionable.goal)})
                      </button>
                    )}
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      ))}
    </div>
  );
};

// ==================== APP ====================
const App = () => {
  const [state, setState] = React.useState(()=> loadState() || null);
  const [tab, setTab] = React.useState('dashboard');
  const [menuOpen, setMenuOpen] = React.useState(false);

  React.useEffect(()=>{ if (state) saveState(state); }, [state]);

  const addExpense = (exp) => setState((s)=> ({ ...s, expenses:[...(s?.expenses||[]), exp] }));
  const removeExpense = (id) => setState((s)=> ({ ...s, expenses:(s.expenses||[]).filter(e=>e.id!==id) }));

  const addGoal = (goal) => setState((s)=> ({ ...s, savingsGoals:[...(s?.savingsGoals||[]), goal] }));
  const updateGoal = (id, newSaved) => setState((s)=> ({ ...s, savingsGoals: (s.savingsGoals||[]).map(g=> g.id===id? {...g, saved: Math.min(g.goal, Math.max(0, newSaved))}: g) }));
  const removeGoal = (id) => setState((s)=> ({ ...s, savingsGoals: (s.savingsGoals||[]).filter(g=> g.id!==id) }));

  const addActionableGoal = (a) => addGoal({ id: uid(), name: a.name, goal: a.goal, saved: 0, createdAt: new Date().toISOString() });

  // Seed demo data if none
  React.useEffect(()=>{
    if (!state) return;
    if ((state.expenses||[]).length===0){
      setState((s)=> ({...s, expenses:[
        { id:uid(), name:'Rent', amount:1200, category:'Housing', dueDay:1 },
        { id:uid(), name:'Utilities', amount:180, category:'Utilities', dueDay:10 },
        { id:uid(), name:'Car Payment', amount:300, category:'Transport', dueDay:15 },
        { id:uid(), name:'Groceries', amount:450, category:'Food', dueDay:28 },
      ]}));
    }
    if ((state.savingsGoals||[]).length===0){
      setState((s)=> ({...s, savingsGoals:[ { id:uid(), name:'Emergency Fund', goal:1000, saved:250, createdAt:new Date().toISOString() } ] }));
    }
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [!!state]);

  if (!state) return <SetupWizard onComplete={(data)=>{ setState(data); }}/>; 

  const totalExpenses = (state.expenses||[]).reduce((sum,e)=> sum + (e.amount||e.monthlyAmount||0), 0);
  const available = (state.income||0) - totalExpenses;

  return (
    <div className="relative">
      <BackgroundCanvas/>

      {/* HEADER */}
      <header className="safe-top sticky top-0 z-50 bg-gray-900/60 backdrop-blur border-b border-white/10">
        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Icons.Phoenix/>
            <div>
              <div className="font-bold leading-tight">Fynix</div>
              <div className="text-xs text-gray-400 -mt-1">Rise From Financial Ashes</div>
            </div>
          </div>
          <nav className="hidden md:flex gap-2 desktop-nav">
            {[
              {id:'dashboard', label:'Dashboard', icon: <Icons.Dashboard/>},
              {id:'budget', label:'Budget', icon: <Icons.Calculator/>},
              {id:'guides', label:'Guides', icon: <Icons.Book/>},
            ].map(t => (
              <button key={t.id} onClick={()=>setTab(t.id)} className={`px-3 py-2 rounded-lg text-sm flex items-center gap-2 ${tab===t.id? 'tab-active':'bg-white/5 hover:bg-white/10'}`}>{t.icon}<span>{t.label}</span></button>
            ))}
          </nav>
          <div className="flex items-center gap-2">
            <div className="hidden sm:block text-right">
              <div className="text-xs text-gray-400">Hi, {state.name||'You'}</div>
              <div className="text-sm font-semibold">{formatCurrency(state.income||0)} / mo</div>
            </div>
            <button onClick={()=>setMenuOpen(!menuOpen)} className="md:hidden p-2 rounded-lg bg-white/5 hover:bg-white/10"><Icons.Menu/></button>
          </div>
        </div>
        {menuOpen && (
          <div className="md:hidden border-t border-white/10 px-4 pb-3">
            <div className="flex gap-2">
              {[
                {id:'dashboard', label:'Dashboard', icon:<Icons.Dashboard/>},
                {id:'budget', label:'Budget', icon:<Icons.Calculator/>},
                {id:'guides', label:'Guides', icon:<Icons.Book/>},
              ].map(t=> (
                <button key={t.id} onClick={()=>{ setTab(t.id); setMenuOpen(false); }} className={`flex-1 px-3 py-2 rounded-lg text-sm flex items-center justify-center gap-2 ${tab===t.id? 'tab-active':'bg-white/5 hover:bg-white/10'}`}>{t.icon}<span>{t.label}</span></button>
              ))}
            </div>
          </div>
        )}
      </header>

      {/* MAIN */}
      <main className="main-content max-w-6xl mx-auto px-4 py-6">
        {tab==='dashboard' && (
          <div className="grid md:grid-cols-3 gap-4 md:gap-6">
            <div className="md:col-span-2 space-y-4">
              <MyCards balance={Math.max(0, available)} />
              <BudgetHealth income={state.income||0} expenses={state.expenses||[]} savings={state.savingsGoals||[]}/>
              <DailyBreakdown expenses={state.expenses||[]} income={state.income||0} settings={state.settings}/>
            </div>
            <div className="space-y-4">
              <ExpenseBreakdownChart expenses={state.expenses||[]}/>
              <SavingsGoals goals={state.savingsGoals||[]} onAdd={addGoal} onUpdate={updateGoal} onRemove={removeGoal}/>
            </div>
          </div>
        )}

        {tab==='budget' && (
          <div className="grid md:grid-cols-3 gap-4 md:gap-6">
            <div className="md:col-span-2 space-y-4">
              <ExpenseManager expenses={state.expenses||[]} onAdd={addExpense} onRemove={removeExpense}/>
              <div className="glass rounded-xl p-4 md:p-6">
                <h3 className="text-base md:text-lg font-semibold mb-2 flex items-center gap-2"><Icons.Calendar/>Upcoming Bills</h3>
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {(state.expenses||[]).slice().sort((a,b)=> (daysUntilDue(a.dueDay)) - (daysUntilDue(b.dueDay))).map(e=> (
                    <div key={e.id} className="bg-gray-800/40 rounded-lg p-3 flex items-center justify-between">
                      <div>
                        <div className="font-medium text-sm">{e.name}</div>
                        <div className="text-xs text-gray-400">Due in {daysUntilDue(e.dueDay)} days</div>
                      </div>
                      <div className="text-right">
                        <div className="font-bold">{formatCurrency(e.amount||e.monthlyAmount||0)}</div>
                        <div className="text-xs text-gray-400">{e.category}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
            <div className="space-y-4">
              <BudgetHealth income={state.income||0} expenses={state.expenses||[]} savings={state.savingsGoals||[]}/>
              <ExpenseBreakdownChart expenses={state.expenses||[]}/>
            </div>
          </div>
        )}

        {tab==='guides' && (
          <Guides onActionable={(a)=> addActionableGoal(a) }/>
        )}
      </main>

      {/* MOBILE NAV */}
      <nav className="mobile-nav safe-bottom">
        {[
          {id:'dashboard', label:'Home', icon:<Icons.Dashboard/>},
          {id:'budget', label:'Budget', icon:<Icons.Calculator/>},
          {id:'guides', label:'Guides', icon:<Icons.Book/>},
        ].map(t => (
          <button key={t.id} onClick={()=>setTab(t.id)} className={`flex-1 flex flex-col items-center py-1 rounded-lg ${tab===t.id? 'tab-active':'text-gray-300'}`}>
            {t.icon}
            <span className="text-[10px] mt-1">{t.label}</span>
          </button>
        ))}
      </nav>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);

// ==================== DEV RUNTIME TESTS ====================
// These are simple runtime checks logged to the console. They don't alter UI.
(function(){
  const test = (name, fn) => { try { fn(); console.log('âœ…', name); } catch(e) { console.error('âŒ', name, e); } };
  test('formatCurrency formats USD', () => { const s = formatCurrency(1234.56); if (!/\$1,234\.56/.test(s)) throw new Error('Got: '+s); });
  test('daysInMonth Feb 2025 is 28', () => { const d = daysInMonth(new Date('2025-02-10')); if (d !== 28) throw new Error('Got: '+d); });
  test('daysUntilDue wraps across months', () => { const t = new Date('2025-01-30T00:00:00'); const res = daysUntilDue(5, t); if (res !== (31-30)+5) throw new Error('Got: '+res); });
})();
</script>
</body>
</html>
